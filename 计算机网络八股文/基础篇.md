# TCP/IP四层模型

## 应用层

应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。
应用层是不用去关心数据是如何传输的，就类似于，我们寄快递的时候，只需要把包裹交给快递员，由他负责运输快递，我们不需要关心快递是如何被运输的。
而且应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态。

## 传输层

包括 TCP和UDP协议 TCP 的全称叫传输控制协议（Transmission Control Protocol），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。

UDP 相对来说就很简单，简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。

## 网络层

网络层负责将数据从一个设备传输到另一个设备，世界上那么多设备，又该如何找到对方呢？因此，网络层需要有区分设备的编号。
我们一般用 IP 地址给设备进行编号，对于 IPv4 协议， IP 地址共 32 位，分成了四段。前面为网络号，后面为主机号。
分为ABC类地址，

## 网络接口层

负责点对点的传输，把ip报文封装成帧，并且用mac地址进行传输，ip地址需要用arp协议翻译成mac地址。

# 键入地址栏搜索之后，发生了什么？

## 解析URL地址

将URL字符串解析，获得服务器名称和文件名称

## DNS解析，获得ip地址

DNS的过程如下：

- 先问根域名服务器，如果有则返回，没有则告诉你它的子域名服务器：com，你自己去问他
- 再问com（顶级域名服务器），如果有则返回，没有则告诉你它的子域名服务器：server.com
- 再问....
  浏览器会对这些数据进行一定的缓存

## 协议栈

数据刚刚再应用层，现在需要通过操作系统内核来将数据包装。
应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行收发数据的操作。

## 可靠传输-TCP协议

http协议是基于TCP的，所以会把数据交给TCP协议进行处理

### TCP三次握手

![TCP 头格式](https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230534096.png)

- 客户端首先带着随机生成的seqNum 请求连接，把SYN标志位设置成1
- 服务端收到后，也随机生成自己的序列号，并把ack设置成收到的客户端seqNum+1，ack标志位和SYN都设置成1
- 客户端再次收到，把确认应答号设成收到的seqNum+1，发给服务端，并且这次可以带数据，ack标志位和SYN都设置成1，之后状态就一直是established状态
- 等到服务端接收，服务端的状态也修改为established，然后就能互相发送消息了。

### 可靠定位-IP协议
封装了TCP报文之后，就携带了源端口和目标端口号，紧接着封装ip报文，包括源ip和目标ip
### 封装mac头

### 出口网卡
加上首尾定界符，把数据转化成点电信号传输

### 经过交换机，路由器到达目的地址
不断解析mac,ip头，tcp头，最后将数据交给对应的应用程序


# linux网络收发
电脑与电脑之间通常都是通过网卡、交换机、路由器等网络设备连接到一起，那由于网络设备的异构性，国际标准化组织定义了一个七层的 OSI 网络模型，但是这个模型由于比较复杂，实际应用中并没有采用，而是采用了更为简化的 TCP/IP 模型，Linux 网络协议栈就是按照了该模型来实现的。

TCP/IP 模型主要分为应用层、传输层、网络层、网络接口层四层，每一层负责的职责都不同，这也是 Linux 网络协议栈主要构成部分。

当应用程序通过 Socket 接口发送数据包，数据包会被网络协议栈从上到下进行逐层处理后，才会被送到网卡队列中，随后由网卡将网络包发送出去。

而在接收网络包时，同样也要先经过网络协议栈从下到上的逐层处理，最后才会被送到应用程序。
